kind: pipeline
name: default
steps:
  - name: ganache
    image: trufflesuite/ganache-cli:v6.4.3
    detach: true

  - name: core
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    privileged: true
    commands:
      - LD_LIBRARY_PATH=/opt/intel/libsgx-enclave-common/aesm /opt/intel/libsgx-enclave-common/aesm/aesm_service
      - . /opt/sgxsdk/environment && . /root/.cargo/env
      - cargo --version
      - cd enigma-core && RUSTFLAGS=-Awarnings make DEBUG=1
      - cd app && RUSTFLAGS=-Awarnings cargo test
    volumes:
      - name: isgx
        path: /dev/isgx

  - name: principal
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    privileged: true
    commands:
      - LD_LIBRARY_PATH=/opt/intel/libsgx-enclave-common/aesm /opt/intel/libsgx-enclave-common/aesm/aesm_service
      - . /opt/sgxsdk/environment && . /root/.cargo/env
      - cd enigma-principal && RUSTFLAGS=-Awarnings make DEBUG=1
      - export NODE_URL="http://ganache:8545"
      - cd app && RUSTFLAGS=-Awarnings cargo test
    volumes:
      - name: isgx
        path: /dev/isgx

  - name: tools_u
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    commands:
      - . /root/.cargo/env
      - export NODE_URL="http://ganache:8545"
      - cd enigma-tools-u
      - RUSTFLAGS=-Awarnings cargo test

  - name: enigma_crypto
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    commands:
      - LD_LIBRARY_PATH=/opt/intel/libsgx-enclave-common/aesm /opt/intel/libsgx-enclave-common/aesm/aesm_service
      - . /opt/sgxsdk/environment && . /root/.cargo/env
      - cd enigma-crypto
      - RUSTFLAGS=-Awarnings cargo test
      - RUSTFLAGS=-Awarnings cargo build --no-default-features --features=sgx

  - name: tools_m
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    commands:
      - LD_LIBRARY_PATH=/opt/intel/libsgx-enclave-common/aesm /opt/intel/libsgx-enclave-common/aesm/aesm_service
      - . /opt/sgxsdk/environment && . /root/.cargo/env
      - cd enigma-tools-m
      - RUSTFLAGS=-Awarnings cargo test
      - RUSTFLAGS=-Awarnings cargo check --no-default-features --features=sgx

  - name: eng_wasm
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    commands:
      - . /root/.cargo/env
      - cd eng-wasm/derive
      - cargo test

  - name: enigma_types
    image: enigmampc/enigma-core:0.0.10
    depends_on: [clone]
    commands:
      - LD_LIBRARY_PATH=/opt/intel/libsgx-enclave-common/aesm /opt/intel/libsgx-enclave-common/aesm/aesm_service
      - . /opt/sgxsdk/environment && . /root/.cargo/env
      - cd enigma-types
      - RUSTFLAGS=-Awarnings cargo test
      - RUSTFLAGS=-Awarnings cargo check
      - RUSTFLAGS=-Awarnings cargo check --features=std
      - RUSTFLAGS=-Awarnings cargo check --features=sgx
      - RUSTFLAGS=-Awarnings cargo check --features=alloc

  - name: integration
    image: enigmampc/docker-client
    depends_on:
      - core
      - principal
    commands:
      - git clone https://github.com/enigmampc/discovery-docker-network.git
      - cd discovery-docker-network && cp .env-template .env
      - sed -i "s/COMPOSE_PROJECT_NAME=.*/COMPOSE_PROJECT_NAME=enigma_${DRONE_BUILD_NUMBER}/" .env
      - export MATCHING_BRANCH_P2P="$(git ls-remote --heads https://github.com/enigmampc/enigma-p2p.git ${DRONE_BRANCH} | wc -l)"
      - export MATCHING_BRANCH_CONTRACT="$(git ls-remote --heads https://github.com/enigmampc/enigma-contract.git ${DRONE_BRANCH} | wc -l)"
      - |
        if [[ "${DRONE_BRANCH}" == "master" ]]; then
          export TAG=latest;
          docker-compose pull
        else
          if ! (( $MATCHING_BRANCH_P2P + $MATCHING_BRANCH_CONTRACT )); then
            export TAG=develop;
            sed -i "s/DOCKER_TAG=latest/DOCKER_TAG=develop/" .env;
            docker-compose pull
          else
            export TAG=$DRONE_BRANCH;
            sed -i "s/DOCKER_TAG=latest/DOCKER_TAG=${TAG}/" .env;
            if [ $MATCHING_BRANCH_P2P -eq 1 ] && [ $MATCHING_BRANCH_CONTRACT -eq 0 ]; then
              cd enigma-p2p && docker build --build-arg GIT_BRANCH_P2P=${DRONE_BRANCH} -t enigmampc/enigma_p2p:$TAG --no-cache . && cd ..
              docker pull enigmampc/enigma_contract:develop
              docker tag enigmampc/enigma_contract:develop enigmampc/enigma_contract:$TAG
            else
              if [ $MATCHING_BRANCH_P2P -eq 0 ] && [ $MATCHING_BRANCH_CONTRACT -eq 1 ]; then
                cd enigma-contract && docker build --build-arg GIT_BRANCH_CONTRACT=${DRONE_BRANCH} -t enigmampc/enigma_contract:$TAG --no-cache . && cd ..
                docker pull enigmampc/enigma_p2p:develop
                docker tag enigmampc/enigma_p2p:develop enigmampc/enigma_p2p:$TAG
              else
                cd enigma-p2p && docker build --build-arg GIT_BRANCH_P2P=${DRONE_BRANCH} -t enigmampc/enigma_p2p:$TAG --no-cache . && cd ..
                cd enigma-contract && docker build --build-arg GIT_BRANCH_CONTRACT=${DRONE_BRANCH} -t enigmampc/enigma_contract:$TAG --no-cache . && cd ..
              fi
            fi
          fi
        fi
      - |
        cd enigma-core &&
        docker build --build-arg GIT_BRANCH_CORE=$DRONE_BRANCH --build-arg SGX_MODE=HW -t enigmampc/enigma_core_hw:$TAG --no-cache . &&
        docker build -f Dockerfile.km --build-arg GIT_BRANCH_CORE=$DRONE_BRANCH --build-arg SGX_MODE=HW -t enigmampc/enigma_km_hw:$TAG --no-cache . &&
        cd ..
      - export NODES=3 && docker-compose -f docker-compose.yml -f docker-compose.hw.yml -f docker-compose.test.yml up --scale core=$NODES --scale p2p=$NODES --exit-code-from client
    privileged: true
    volumes:
      - name: sock
        path: /var/run/docker.sock

  - name: deploy
    image: enigmampc/docker-client
    depends_on:
      - integration
    when:
      branch:
        - develop
        - master
    environment:
      USERNAME:
        from_secret: username
      PASSWORD:
        from_secret: password
    commands:
      - cd discovery-docker-network/enigma-core
      - echo $PASSWORD | docker login -u $USERNAME --password-stdin
      - if [[ ${DRONE_BRANCH} == "master" ]]; then export TAG=latest; else export TAG=develop; fi
      - docker build --build-arg GIT_BRANCH_CORE=$DRONE_BRANCH --build-arg SGX_MODE=HW -t enigmampc/enigma_core_hw:$TAG --no-cache .
      - docker push enigmampc/enigma_core_hw:$TAG
      - docker build -f Dockerfile.km --build-arg GIT_BRANCH_CORE=$DRONE_BRANCH --build-arg SGX_MODE=HW -t enigmampc/enigma_km_hw:$TAG --no-cache .
      - docker push enigmampc/enigma_km_hw:$TAG
      - docker build --build-arg GIT_BRANCH_CORE=$DRONE_BRANCH --build-arg SGX_MODE=SW -t enigmampc/enigma_core_sw:$TAG --no-cache .
      - docker push enigmampc/enigma_core_sw:$TAG
      - docker build -f Dockerfile.km --build-arg GIT_BRANCH_CORE=$DRONE_BRANCH --build-arg SGX_MODE=SW -t enigmampc/enigma_km_sw:$TAG --no-cache .
      - docker push enigmampc/enigma_km_sw:$TAG
    privileged: true
    volumes:
      - name: sock
        path: /var/run/docker.sock

  - name: cleanup
    image: enigmampc/docker-client
    depends_on:
      - integration
    when:
      branch:
          exclude:
            - master
            - develop
    commands:
      - |
        if (( $MATCHING_BRANCH_P2P + $MATCHING_BRANCH_CONTRACT )); then
          docker rmi enigmampc/enigma_core_hw:$TAG
          docker rmi enigmampc/enigma_km_hw:$TAG
          docker rmi enigmampc/enigma_contract:$TAG
          docker rmi enigmampc/enigma_p2p:$TAG
        fi

volumes:
  - name: isgx
    host:
      path: /dev/isgx
  - name: sock
    host:
      path: /var/run/docker.sock
